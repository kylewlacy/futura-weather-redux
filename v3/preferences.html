<!doctype html>
<html>
	<head>
		<title>Futura Weather Redux Preferences</title>
		<style type="text/css">
			body {
				font-family: futura, sans-serif;
			}
			
			label, select, input, button {
				display: block;
			}
			
			select, input, button {
				margin-bottom: 18px;
			}
		</style>
		<script>
			var translations = {};
			
			// Called by l10n.js
			function addLocalizations(localizations) {
				translations = localizations.translations;
			}
			
			function queryStringParams() {
				var params = {};
				var queries = window.location.search.substring(1).split("&");
				for(var i = 0; i < queries.length; i++) {
					var p = queries[i].split("=");
					params[p[0]] = p[1];
				}
				
				return params;
			}
			
			// http://stackoverflow.com/a/1354491/1311454
			function htmlEncode(str) {
				return decodeURIComponent(escape(str)).replace(/[\u00A0-\u2666]/g, function(c) {
				   return '&#'+c.charCodeAt(0)+';';
				});
			}
			
			function buildLanguagePicker() {
				var select = document.getElementById("language");
				for(var key in translations) {
					var option = document.createElement("option");
					option.value = key;
					var html = htmlEncode(translations[key].name);
					console.log(html);
					option.innerHTML = htmlEncode(translations[key].name);
					
					select.appendChild(option);
				}
			}
			
			window.onload = function() {
				buildLanguagePicker();
				
				var params = queryStringParams();
				for(var key in params) {
					var elements = document.getElementsByName(key);
					if(elements.length > 0) {
						var e = elements[0];
						if(e.type == "checkbox")
							e.checked = (params[key] != 0);
						else
							e.value = params[key];
					}
				}
			};
			
				
			window.onsubmit = function(e) {
				var params = {};
				var children = e.target.childNodes;
				for(var i = 0; i < children.length; i++) {
					if(children[i].name && children[i].value) {
						if(children[i].type == "checkbox") {
							params[children[i].name] = children[i].checked ? 1 : 0;
						}
						else if(children[i].name == "languageCode") {
							params["translation"] = translations[children[i].value].translation;
							params[children[i].name] = Number(children[i].value);
						}
						else {
							params[children[i].name] = children[i].value;
						}
					}
				}
				
				window.location = "pebblejs://close#" + JSON.stringify(params);
				return false;
			}
		</script>
		<script type="text/javascript" src="../l10n.js"></script>
	</head>
	<body>
		<h1>Futura Weather Redux</h1>
		<form name="preferences">
			<label for="tempFormat">Temperature format</label>
			<select name="tempFormat">
				<option value="1">Celsius</option>
				<option value="2">Fahrenheit</option>
			</select>
			<label for="weatherUpdateFreq">Weather update frequency</label>
			<select name="weatherUpdateFreq">
				<option value="600">Every 10 minutes</option>
				<option value="900">Every 15 minutes</option>
				<option value="1800">Every 30 minutes</option>
				<option value="3600">Every hour</option>
			</select>
			<label for="weatherOutdatedTime">Hide outdated weather after:</label>
			<select name="weatherOutdatedTime">
				<option value="1800">30 minutes</option>
				<option value="3600">1 hour</option>
				<option value="10800">3 hours</option>
			</select>
			<label for="weatherProvider">Weather data provider</label>
			<select name="weatherProvider">
				<option value="1">OpenWeatherMap</option>
				<option value="2">Yahoo Weather</option>
				<option value="3">yr.no</option>
			</select>
			<label for="statusbar">Show statusbar</label>
			<input name="statusbar" type="checkbox" />
			<label for="languageCode">Language</label>
			<select name="languageCode" id="language">
				<!-- Constructed in buildLanguagePicker() -->
			</select>
			<button name="save" type="submit">Save</button>
		</form>
	</body>
</html>